<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <title>Судоку Мастерс</title>
    <!-- VK Bridge -->
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <!-- Tone.js for Audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-family: 'Poppins', sans-serif;
            
            /* New Light Theme Palette */
            --bg-light: #F8FAFC;
            --surface-light: #FFFFFF;
            --primary-light: #14B8A6; /* Teal */
            --primary-light-transparent: #14b8a61a;
            --text-primary-light: #0F172A;
            --text-secondary-light: #64748B;
            --border-light: #E2E8F0;
            --error-light: #F43F5E; /* Rose */
            --highlight-light: #F1F5F9;

            /* New Dark Theme Palette */
            --bg-dark: #0F172A; /* Slate */
            --surface-dark: #1E293B;
            --primary-dark: #2DD4BF;
            --primary-dark-transparent: #2dd4bf1a;
            --text-primary-dark: #F1F5F9;
            --text-secondary-dark: #94A3B8;
            --border-dark: #334155;
            --error-dark: #FB7185;
            --highlight-dark: #334155;
        }

        [data-theme="dark"] {
            --bg-light: var(--bg-dark);
            --surface-light: var(--surface-dark);
            --primary-light: var(--primary-dark);
            --primary-light-transparent: var(--primary-dark-transparent);
            --text-primary-light: var(--text-primary-dark);
            --text-secondary-light: var(--text-secondary-dark);
            --border-light: var(--border-dark);
            --error-light: var(--error-dark);
            --highlight-light: var(--highlight-dark);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overscroll-behavior-y: contain; }
        body { font-family: var(--font-family); background-color: var(--bg-light); color: var(--text-primary-light); display: flex; justify-content: center; align-items: center; transition: background-color 0.3s, color 0.3s; overflow: hidden; }
       
        #app { width: 100%; height: 100%; max-width: 500px; display: flex; flex-direction: column; justify-content: space-between; align-items: center; padding: 15px; padding-top: env(safe-area-inset-top, 15px); padding-bottom: env(safe-area-inset-bottom, 15px); user-select: none; -webkit-user-select: none; }
        .hidden { display: none !important; }

        /* Main Menu Redesign */
        #main-menu {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            gap: 20px;
        }
        .title-container { text-align: center; margin-bottom: 20px;}
        .title-container h1 { 
            font-size: clamp(3rem, 12vw, 4.5rem); 
            font-weight: 700; 
            color: var(--primary-light);
            letter-spacing: -2px;
        }
        .difficulty-buttons { 
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%; max-width: 350px; 
        }
        .menu-button {
            background-color: var(--surface-light);
            color: var(--text-primary-light);
            font-size: clamp(1rem, 2.5vh, 1.1rem);
            font-weight: 600;
            border: 1px solid var(--border-light);
            padding: clamp(14px, 2.5vh, 20px) 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .menu-button:hover { transform: translateY(-3px); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        #stats-button {
            grid-column: 1 / -1;
            background-color: var(--primary-light);
            color: #fff;
            border-color: var(--primary-light);
        }
       
        #menu-footer { 
            position: absolute;
            bottom: env(safe-area-inset-bottom, 20px);
            display: flex;
            justify-content: center;
            width: 100%;
        }
        .theme-switcher { 
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: var(--surface-light);
            border: 1px solid var(--border-light);
            padding: 8px;
            border-radius: 50px;
            cursor: pointer;
        }
        .theme-switcher svg { width: 24px; height: 24px; color: var(--text-secondary-light); }
        .theme-switcher .icon-active { color: var(--primary-light); }
        
        /* Game Screen Redesign */
        #game-screen {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 5px 0;
            width: 100%; 
            flex-shrink: 0;
        }
        .header-block { display: flex; align-items: center; flex: 1; }
        .header-block.left { justify-content: flex-start; }
        .header-block.center { justify-content: center; flex-direction: column; }
        .header-block.right { justify-content: flex-end; }

        .icon-button { background: none; border: none; cursor: pointer; width: 44px; height: 44px; display: flex; justify-content: center; align-items: center; color: var(--text-secondary-light); }
        .icon-button svg { width: 26px; height: 26px; }

        #difficulty-display { font-weight: 600; font-size: 1.1rem; }
        #timer { font-size: 1rem; color: var(--text-secondary-light); }
        #lives { display: flex; gap: 4px; color: var(--error-light); }
       
        #board-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            flex-grow: 1;
            min-height: 0;
            padding: 10px 0;
        }
       
        #sudoku-board {
            border-collapse: collapse;
            border: 2px solid var(--text-primary-light);
            aspect-ratio: 1 / 1;
            margin: auto;
            border-radius: 8px;
            overflow: hidden;
        }
        #sudoku-board td {
            border: 1px solid var(--border-light);
            text-align: center;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            width: 11.111%;
            height: 11.111%;
            position: relative;
        }
       
        #sudoku-board td:nth-child(3n) { border-right: 2px solid var(--text-secondary-light); }
        #sudoku-board tr:nth-child(3n) { border-bottom: 2px solid var(--text-secondary-light); }
        #sudoku-board td:last-child { border-right: none; }
        #sudoku-board tr:last-child td { border-bottom: none; }

        .initial-number { color: var(--text-primary-light); font-weight: 700; }
        .player-number { color: var(--primary-light); font-weight: 600; }
        .incorrect { color: var(--error-light) !important; animation: shake 0.3s; }
        .highlight-area { background-color: var(--highlight-light) !important; }
        .highlight-number { background-color: var(--primary-light-transparent) !important; }
        .selected::after {
            content: '';
            position: absolute;
            top: 2px; left: 2px; right: 2px; bottom: 2px;
            border: 3px solid var(--primary-light);
            border-radius: 4px;
        }

        /* Controls Redesign */
        #controls { display: flex; flex-direction: column; gap: 10px; padding-top: 10px; width: 100%; flex-shrink: 0; }
        #number-pad { display: grid; grid-template-columns: repeat(9, 1fr); gap: 8px; }
        #action-pad { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        
        .control-button {
            background-color: var(--surface-light);
            color: var(--text-primary-light);
            font-size: clamp(1.2rem, 4vh, 1.8rem);
            font-weight: 600;
            border: 1px solid var(--border-light);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            aspect-ratio: 1 / 1;
        }
        .control-button:active { transform: scale(0.95); background-color: var(--highlight-light); }
        #action-pad .control-button { border-radius: 12px; aspect-ratio: auto; height: 50px; }
       
        #action-pad .control-button svg { width: clamp(22px, 6vw, 28px); height: clamp(22px, 6vw, 28px); }
        .ad-badge {
            position: absolute;
            top: -2px; right: -2px;
            background-color: var(--primary-light);
            color: white;
            padding: 1px 4px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            line-height: 1;
            border: 2px solid var(--surface-light);
        }

        /* Modal Redesign */
        .modal-overlay { backdrop-filter: blur(8px); }
        .modal-content { 
            background-color: var(--surface-light); 
            padding: 30px; 
            border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            border: 1px solid var(--border-light);
        }
        .modal-content h2 { font-size: 1.8rem; font-weight: 700; margin-bottom: 10px; }
        .modal-content p { margin-bottom: 20px; font-size: 1rem; color: var(--text-secondary-light); }
        .primary { background-color: var(--primary-light); color: #fff; border: none; }
       
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-3px); } 75% { transform: translateX(3px); } }
    </style>
</head>
<body>
    <audio id="bg-music" loop src="music.mp3"></audio>
    <div id="app">
        <div id="main-menu">
            <div class="title-container">
                <h1>Судоку Мастерс</h1>
            </div>
            <div class="difficulty-buttons">
                <button class="menu-button" data-difficulty="easy">Легкий</button>
                <button class="menu-button" data-difficulty="medium">Средний</button>
                <button class="menu-button" data-difficulty="hard">Сложный</button>
                <button class="menu-button" data-difficulty="expert">Эксперт</button>
                <button class="menu-button" data-difficulty="extreme">Экстремальный</button>
                <button id="stats-button" class="menu-button">Статистика</button>
            </div>
            <div id="menu-footer">
                <div class="theme-switcher">
                    <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                    <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                </div>
            </div>
        </div>


        <div id="game-screen" class="hidden">
            <header>
                 <div class="header-block left">
                    <button id="pause-btn" class="icon-button">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="8" y2="18"></line><line x1="16" y1="6" x2="16" y2="18"></line></svg>
                    </button>
                    <button id="sound-toggle-btn" class="icon-button">
                        <svg id="sound-on-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                        <svg id="sound-off-icon" class="hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>
                    </button>
                 </div>
                <div class="header-block center">
                    <div id="difficulty-display"></div>
                    <div id="timer">00:00</div>
                </div>
                <div class="header-block right">
                    <div id="lives"></div>
                </div>
             </header>
            <div id="board-container">
                <table id="sudoku-board"></table>
            </div>
            <div id="controls">
                <div id="action-pad"></div>
                <div id="number-pad"></div>
            </div>
        </div>

        <div id="continue-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <h2>Сохраненная игра</h2>
                <p>У вас есть незаконченная игра. Хотите продолжить?</p>
                <div class="modal-buttons">
                    <button id="continue-game-btn" class="menu-button primary">Продолжить</button>
                    <button id="new-game-continue-btn" class="menu-button">Начать заново</button>
                </div>
            </div>
        </div>
        <div id="pause-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <h2>Пауза</h2>
                <div class="modal-buttons">
                    <button id="resume-button" class="menu-button primary">Продолжить</button>
                    <button id="restart-button" class="menu-button">Начать заново</button>
                    <button id="main-menu-btn-pause" class="menu-button">Главное меню</button>
                </div>
            </div>
        </div>
        <div id="game-over-modal" class="modal-overlay hidden">
             <div class="modal-content">
                <h2>Вы проиграли</h2>
                <div class="modal-buttons">
                    <button id="extra-life-btn" class="menu-button primary">Доп. жизнь (Ad)</button>
                    <button id="restart-game-over-btn" class="menu-button">Начать заново</button>
                    <button id="main-menu-game-over-btn" class="menu-button">Главное меню</button>
                </div>
            </div>
        </div>
        <div id="win-modal" class="modal-overlay hidden">
             <div class="modal-content">
                <h2>Поздравляем!</h2>
                <p id="completion-time"></p>
                <div class="modal-buttons">
                    <button id="new-game-win-btn" class="menu-button primary">Новая игра</button>
                    <button id="main-menu-win-btn" class="menu-button">Главное меню</button>
                </div>
            </div>
        </div>
        <div id="stats-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <h3>Статистика</h3>
                <div class="modal-body">
                     <div id="stats-table-container"></div>
                </div>
                <div class="modal-buttons">
                    <button id="close-stats-btn" class="menu-button primary">Закрыть</button>
                </div>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        vkBridge.send('VKWebAppInit');
        document.addEventListener('contextmenu', e => e.preventDefault());
       
        const mainMenu = document.getElementById('main-menu');
        const gameScreen = document.getElementById('game-screen');
        const sudokuBoard = document.getElementById('sudoku-board');
        const numberPad = document.getElementById('number-pad');
        const actionPad = document.getElementById('action-pad');
        const difficultyDisplay = document.getElementById('difficulty-display');
        const timerDisplay = document.getElementById('timer');
        const livesDisplay = document.getElementById('lives');
        const pauseBtn = document.getElementById('pause-btn');
        const themeSwitcher = document.querySelector('.theme-switcher');
        const difficultyButtonsContainer = document.querySelector('.difficulty-buttons');
        // Modals
        const continueModal = document.getElementById('continue-modal');
        const pauseModal = document.getElementById('pause-modal');
        const gameOverModal = document.getElementById('game-over-modal');
        const winModal = document.getElementById('win-modal');
        const statsModal = document.getElementById('stats-modal');
        // Modal Buttons
        const continueGameBtn = document.getElementById('continue-game-btn');
        const newGameContinueBtn = document.getElementById('new-game-continue-btn');
        const resumeButton = document.getElementById('resume-button');
        const restartButton = document.getElementById('restart-button');
        const mainMenuBtnFromPause = document.getElementById('main-menu-btn-pause');
        const extraLifeBtn = document.getElementById('extra-life-btn');
        const restartGameOverBtn = document.getElementById('restart-game-over-btn');
        const mainMenuGameOverBtn = document.getElementById('main-menu-game-over-btn');
        const completionTimeDisplay = document.getElementById('completion-time');
        const newGameWinBtn = document.getElementById('new-game-win-btn');
        const mainMenuWinBtn = document.getElementById('main-menu-win-btn');
        const statsButton = document.getElementById('stats-button');
        const closeStatsBtn = document.getElementById('close-stats-btn');
        // Audio
        const bgMusic = document.getElementById('bg-music');
        const soundToggleBtn = document.getElementById('sound-toggle-btn');
        // Theme
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');
        
        let vkUserId = null;
        let wasMusicPlaying = false;
        let timerInterval;
        let startTime;
        let elapsedTime = 0;
        const difficultyLevels = { easy: 30, medium: 40, hard: 50, expert: 55, extreme: 60 };
        const difficultyMap = { easy: 'Легкий', medium: 'Средний', hard: 'Сложный', expert: 'Эксперт', extreme: 'Экстремальный' };
        let currentLevel = '';
        let selectedCell = null;
        let solutionGrid = [], initialGrid = [], playerGrid = [];
        let lives = 3;
        let isPaused = false;
        let stats = {};
        let isMuted = false;
        let savedGameState = null;

        const audioManager = {
            clickSynth: null, winSynth: null, errorSynth: null, isReady: false,
            init() {
                this.clickSynth = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.1 } }).toDestination();
                this.clickSynth.volume.value = -20;
                this.winSynth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'triangle8' }, envelope: { attack: 0.02, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination();
                this.winSynth.volume.value = -10;
                this.errorSynth = new Tone.MonoSynth({ oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.2 } }).toDestination();
                this.errorSynth.volume.value = -15;
                bgMusic.volume = 0.05;
                this.isReady = true;
            },
            playSound(sound) {
                if (!this.isReady || isMuted) return;
                try {
                    const now = Tone.now();
                    if (sound === 'click') this.clickSynth.triggerAttackRelease('E5', '8n', now);
                    if (sound === 'win') {
                        const notes = ["G4", "B4", "D5", "G5"];
                        notes.forEach((note, i) => this.winSynth.triggerAttackRelease(note, "16n", now + i * 0.1));
                    }
                    if (sound === 'error') this.errorSynth.triggerAttackRelease('F#3', '8n', now);
                } catch(e) { console.error("Sound play error", e); }
            },
            toggleMute(forceState) {
                isMuted = (typeof forceState === 'boolean') ? forceState : !isMuted;
                document.getElementById('sound-on-icon').classList.toggle('hidden', isMuted);
                document.getElementById('sound-off-icon').classList.toggle('hidden', !isMuted);
                Tone.Master.mute = isMuted;
                if (isMuted) {
                    bgMusic.pause();
                } else {
                    if (mainMenu.classList.contains('active') || gameScreen.classList.contains('active')) {
                         bgMusic.play().catch(e => {});
                    }
                }
                if(typeof forceState === 'undefined') saveData();
            }
        };

        async function init() {
            try {
                const user = await vkBridge.send('VKWebAppGetUserInfo');
                vkUserId = user.id;
            } catch (error) {
                console.error("VK User Info Error:", error);
                vkUserId = 'test_user';
            }
            await loadData();
            updateThemeUI(localStorage.getItem('sudokuTheme') || 'light');
            addEventListeners();
            if (savedGameState) {
                continueModal.classList.remove('hidden');
            } else {
                showMainMenu();
            }
        }

        async function saveData() {
            if (!vkUserId) return;
            const hasProgress = playerGrid.length > 0 && playerGrid.flat().some(cell => cell !== null);
            const gameStateToSave = hasProgress ? { playerGrid, initialGrid, solutionGrid, currentLevel, lives, elapsedTime } : null;
            const dataToSave = JSON.stringify({ stats, isMuted, savedGame: gameStateToSave });
            try {
                await vkBridge.send('VKWebAppStorageSet', { key: `sudoku_masters_data_${vkUserId}`, value: dataToSave });
            } catch (e) {
                console.error("VK save error:", e);
                localStorage.setItem(`sudoku_masters_data_${vkUserId}`, dataToSave);
            }
        }

        function clearSavedGame() {
            savedGameState = null;
            const dataToSave = JSON.stringify({ stats, isMuted, savedGame: null });
             if (!vkUserId) return;
             try {
                vkBridge.send('VKWebAppStorageSet', { key: `sudoku_masters_data_${vkUserId}`, value: dataToSave });
            } catch (e) {
                localStorage.setItem(`sudoku_masters_data_${vkUserId}`, dataToSave);
            }
        }
       
        async function loadData() {
            if (!vkUserId) return;
            let loadedData = null;
            try {
                const response = await vkBridge.send('VKWebAppStorageGet', { keys: [`sudoku_masters_data_${vkUserId}`] });
                if (response.keys[0]?.value) {
                    loadedData = JSON.parse(response.keys[0].value);
                }
            } catch (e) {
                console.error("VK load error:", e);
                const localData = localStorage.getItem(`sudoku_masters_data_${vkUserId}`);
                if (localData) loadedData = JSON.parse(localData);
            }
            if (loadedData) {
                stats = loadedData.stats || {};
                audioManager.toggleMute(loadedData.isMuted || false);
                savedGameState = loadedData.savedGame || null;
            }
        }

        function showMainMenu() {
            mainMenu.classList.remove('hidden');
            mainMenu.classList.add('active');
            gameScreen.classList.add('hidden');
            gameScreen.classList.remove('active');
            if(!isMuted) bgMusic.play().catch(e=>{});
            vkBridge.send('VKWebAppShowBannerAd', { banner_location: 'bottom' }).catch(e => {});
        }

        function startGame(level) {
            currentLevel = level;
            difficultyDisplay.textContent = difficultyMap[level];
            mainMenu.classList.add('hidden');
            mainMenu.classList.remove('active');
            gameScreen.classList.remove('hidden');
            gameScreen.classList.add('active');
            resetGame();
            vkBridge.send('VKWebAppShowBannerAd', { banner_location: 'bottom' }).catch(e => {});
            setTimeout(adjustBoardSize, 0);
        }

        function continueGame() {
            if (!savedGameState) return;
            ({ playerGrid, initialGrid, solutionGrid, currentLevel, lives, elapsedTime } = savedGameState);
            
            difficultyDisplay.textContent = difficultyMap[currentLevel];
            mainMenu.classList.add('hidden');
            mainMenu.classList.remove('active');
            gameScreen.classList.remove('hidden');
            gameScreen.classList.add('active');
            isPaused = false;
            selectedCell = null;
            clearInterval(timerInterval);
            updateLivesDisplay();
            drawBoard();
            startTimer();
            if(!isMuted) bgMusic.play().catch(e=>{});
            vkBridge.send('VKWebAppShowBannerAd', { banner_location: 'bottom' }).catch(e => {});
            setTimeout(adjustBoardSize, 0);
        }
       
        function resetGame() {
            lives = 3;
            elapsedTime = 0;
            isPaused = false;
            selectedCell = null;
            clearInterval(timerInterval);
            updateLivesDisplay();
            generateSudoku();
            drawBoard();
            startTimer();
        }

        function generateSudoku() {
            solutionGrid = createFullGrid();
            initialGrid = JSON.parse(JSON.stringify(solutionGrid));
            removeCells(initialGrid, difficultyLevels[currentLevel]);
            playerGrid = JSON.parse(JSON.stringify(initialGrid));
        }

        function drawBoard() {
            sudokuBoard.innerHTML = '';
            for (let r = 0; r < 9; r++) {
                const row = sudokuBoard.insertRow();
                for (let c = 0; c < 9; c++) {
                    const cell = row.insertCell();
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    const initialValue = initialGrid[r][c];
                    const playerValue = playerGrid[r][c];
                    if (initialValue !== null) {
                        cell.textContent = initialValue;
                        cell.classList.add('initial-number');
                    } else if (playerValue !== null) {
                        cell.textContent = playerValue;
                        cell.classList.add('player-number');
                    }
                }
            }
        }

        function adjustBoardSize() {
            const container = document.getElementById('board-container');
            if (!container || !sudokuBoard) return;
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            const size = Math.min(containerWidth, containerHeight);
            sudokuBoard.style.width = `${size}px`;
            sudokuBoard.style.height = `${size}px`;
            const fontSize = `${size / 18}px`; // Slightly larger font
            sudokuBoard.querySelectorAll('td').forEach(cell => cell.style.fontSize = fontSize);
        }

        function handleCellClick(cell) {
            if (isPaused) return;
            audioManager.playSound('click');
            if (selectedCell === cell) {
                cell.classList.remove('selected');
                selectedCell = null;
                clearHighlights();
                return;
            }
            if (selectedCell) selectedCell.classList.remove('selected');
            clearHighlights();
            selectedCell = cell;
            cell.classList.add('selected');
            const row = cell.dataset.row;
            const col = cell.dataset.col;
            highlightArea(row, col);
            if (cell.textContent) highlightNumber(cell.textContent);
        }

        function handleNumberInput(num) {
            if (!selectedCell || selectedCell.classList.contains('initial-number') || isPaused) return;
            audioManager.playSound('click');
            const r = parseInt(selectedCell.dataset.row);
            const c = parseInt(selectedCell.dataset.col);

            if (num === null) {
                playerGrid[r][c] = null;
                selectedCell.textContent = '';
                selectedCell.classList.remove('incorrect', 'player-number');
            } else {
                playerGrid[r][c] = num;
                selectedCell.textContent = num;
                selectedCell.classList.add('player-number');
            }
            
            saveData();
           
            if (num !== null && num !== solutionGrid[r][c]) {
                selectedCell.classList.add('incorrect');
                loseLife();
            } else {
                if(num !== null) selectedCell.classList.remove('incorrect');
                clearHighlights();
                highlightArea(r,c);
                if (num) highlightNumber(num);
                selectedCell.classList.add('selected');
                checkWin();
            }
        }
       
        async function handleHint() {
            audioManager.playSound('click');
            if(isPaused) return;
            try {
                await vkBridge.send('VKWebAppCheckNativeAds', { ad_format: 'reward' });
                const adData = await vkBridge.send('VKWebAppShowNativeAds', { ad_format: 'reward' });
                if (adData.result) {
                    const emptyCells = [];
                    for(let r=0; r<9; r++) for(let c=0; c<9; c++) if(playerGrid[r][c] === null) emptyCells.push({r, c});
                    if (emptyCells.length > 0) {
                        const randomCell = emptyCells[Math.floor(Math.random() * emptyCells.length)];
                        handleCellClick(sudokuBoard.rows[randomCell.r].cells[randomCell.c]);
                        handleNumberInput(solutionGrid[randomCell.r][randomCell.c]);
                    }
                }
            } catch (e) { console.error("Rewarded ad error:", e); }
        }

        function loseLife() {
            audioManager.playSound('error');
            lives--;
            updateLivesDisplay();
            if (lives <= 0) {
                clearInterval(timerInterval);
                gameOverModal.classList.remove('hidden');
                clearSavedGame();
            }
        }

        async function getExtraLife() {
            audioManager.playSound('click');
            try {
                await vkBridge.send('VKWebAppCheckNativeAds', { ad_format: 'reward' });
                const adData = await vkBridge.send('VKWebAppShowNativeAds', { ad_format: 'reward' });
                if (adData.result) {
                    lives++;
                    updateLivesDisplay();
                    gameOverModal.classList.add('hidden');
                    startTimer();
                }
            } catch (e) { console.error("Rewarded ad error:", e); }
        }

        function updateLivesDisplay() {
            livesDisplay.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                const heart = document.createElement('span');
                heart.innerHTML = i < lives
                    ? `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`
                    : `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity:0.3"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`;
                livesDisplay.appendChild(heart);
            }
        }

        function clearHighlights() {
            document.querySelectorAll('#sudoku-board td').forEach(c => c.classList.remove('highlight-area', 'highlight-number'));
        }
        function highlightArea(row, col) {
            for (let i = 0; i < 9; i++) {
                sudokuBoard.rows[row].cells[i].classList.add('highlight-area');
                sudokuBoard.rows[i].cells[col].classList.add('highlight-area');
            }
        }
        function highlightNumber(num) {
            document.querySelectorAll('#sudoku-board td').forEach(cell => { if (cell.textContent == num) cell.classList.add('highlight-number') });
        }

        function checkWin() {
            for (let r = 0; r < 9; r++) for (let c = 0; c < 9; c++) if (playerGrid[r][c] !== solutionGrid[r][c]) return false;
            
            clearInterval(timerInterval);
            audioManager.playSound('win');
            completionTimeDisplay.textContent = `Время: ${timerDisplay.textContent}`;
            winModal.classList.remove('hidden');
            updateStatsOnWin();
            clearSavedGame();
            vkBridge.send('VKWebAppShowInterstitialAd').catch(e => console.log("Interstitial Ad error", e));
            return true;
        }

        function startTimer() {
            clearInterval(timerInterval);
            startTime = Date.now() - elapsedTime * 1000;
            timerInterval = setInterval(() => {
                elapsedTime = Math.floor((Date.now() - startTime) / 1000);
                const minutes = String(Math.floor(elapsedTime / 60)).padStart(2, '0');
                const seconds = String(elapsedTime % 60).padStart(2, '0');
                timerDisplay.textContent = `${minutes}:${seconds}`;
             }, 1000);
        }

        function togglePause() {
            audioManager.playSound('click');
            isPaused = !isPaused;
            if (isPaused) {
                clearInterval(timerInterval);
                pauseModal.classList.remove('hidden');
            } else {
                startTimer();
                pauseModal.classList.add('hidden');
            }
        }

        function updateThemeUI(theme) {
            document.body.dataset.theme = theme;
            localStorage.setItem('sudokuTheme', theme);
            if (theme === 'light') {
                sunIcon.classList.add('icon-active');
                moonIcon.classList.remove('icon-active');
            } else {
                sunIcon.classList.remove('icon-active');
                moonIcon.classList.add('icon-active');
            }
        }
        function toggleTheme() {
            const newTheme = (localStorage.getItem('sudokuTheme') || 'light') === 'light' ? 'dark' : 'light';
            updateThemeUI(newTheme);
            audioManager.playSound('click');
        }

        function updateStatsOnWin() {
            if (!stats[currentLevel]) stats[currentLevel] = { wins: 0, bestTime: null };
            const levelStats = stats[currentLevel];
            levelStats.wins++;
            if (levelStats.bestTime === null || elapsedTime < levelStats.bestTime) {
                levelStats.bestTime = elapsedTime;
            }
            saveData();
        }

        function renderStatsTable() {
            const container = document.getElementById('stats-table-container');
            container.innerHTML = '';
            const table = document.createElement('table');
            table.className = 'stats-table';
            const headers = ['Сложность', 'Побед', 'Лучшее время'];
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            headers.forEach(text => { const th = document.createElement('th'); th.textContent = text; headerRow.appendChild(th); });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            const tbody = document.createElement('tbody');
            Object.keys(difficultyLevels).forEach(levelKey => {
                const levelName = difficultyMap[levelKey];
                const levelStats = stats[levelKey] || { wins: 0, bestTime: null };
                const tr = document.createElement('tr');
                const formatTime = (s) => s === null ? '—' : `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
                const values = { 'Сложность': levelName, 'Побед': levelStats.wins || '—', 'Лучшее время': formatTime(levelStats.bestTime) };
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = values[header];
                    td.dataset.label = header + ': ';
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            container.appendChild(table);
        }

        function debounce(func, delay) {
            let timeout;
            return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); };
        }

        function addEventListeners() {
            const genericClickHandler = (action) => { audioManager.playSound('click'); action(); };
            
            difficultyButtonsContainer.addEventListener('click', (e) => {
                const button = e.target.closest('.menu-button');
                if (button && button.dataset.difficulty) {
                    genericClickHandler(() => startGame(button.dataset.difficulty));
                }
            });
            statsButton.addEventListener('click', () => genericClickHandler(() => { renderStatsTable(); statsModal.classList.remove('hidden'); }));
            closeStatsBtn.addEventListener('click', () => genericClickHandler(() => statsModal.classList.add('hidden')));
            themeSwitcher.addEventListener('click', toggleTheme);
            sudokuBoard.addEventListener('click', (e) => { if (e.target.tagName === 'TD') { handleCellClick(e.target); } });

            numberPad.innerHTML = '';
            actionPad.innerHTML = '';
            for(let i=1; i<=9; i++) {
                const btn = document.createElement('button');
                btn.className = 'control-button';
                btn.textContent = i;
                btn.onclick = () => handleNumberInput(i);
                numberPad.appendChild(btn);
            }
           
            const hintBtn = document.createElement('button');
            hintBtn.className = 'control-button hint-button';
            hintBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg><span class="ad-badge">Ad</span>`;
            hintBtn.onclick = handleHint;
           
            const eraseBtn = document.createElement('button');
            eraseBtn.className = 'control-button';
            eraseBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 7.5l-15 15-5-5 15-15 5 5z"></path><path d="M10.5 5.5L18 13"></path></svg>`;
            eraseBtn.onclick = () => handleNumberInput(null);

            actionPad.appendChild(hintBtn);
            actionPad.appendChild(eraseBtn);
           
            pauseBtn.addEventListener('click', togglePause);
            resumeButton.addEventListener('click', togglePause);
            restartButton.addEventListener('click', () => genericClickHandler(() => { pauseModal.classList.add('hidden'); resetGame(); setTimeout(adjustBoardSize, 0); }));
            mainMenuBtnFromPause.addEventListener('click', () => genericClickHandler(() => { pauseModal.classList.add('hidden'); clearSavedGame(); showMainMenu(); }));
            extraLifeBtn.addEventListener('click', getExtraLife);
            restartGameOverBtn.addEventListener('click', () => genericClickHandler(() => { gameOverModal.classList.add('hidden'); resetGame(); setTimeout(adjustBoardSize, 0); }));
            mainMenuGameOverBtn.addEventListener('click', () => genericClickHandler(() => { gameOverModal.classList.add('hidden'); clearSavedGame(); showMainMenu(); }));
            newGameWinBtn.addEventListener('click', () => genericClickHandler(() => {
                winModal.classList.add('hidden');
                const difficulties = Object.keys(difficultyLevels);
                startGame(difficulties[Math.floor(Math.random() * difficulties.length)]);
            }));
            mainMenuWinBtn.addEventListener('click', () => genericClickHandler(() => { winModal.classList.add('hidden'); showMainMenu(); }));
            soundToggleBtn.addEventListener('click', () => { audioManager.toggleMute(); audioManager.playSound('click'); });
            continueGameBtn.addEventListener('click', () => genericClickHandler(() => { continueModal.classList.add('hidden'); continueGame(); }));
            newGameContinueBtn.addEventListener('click', () => genericClickHandler(() => { continueModal.classList.add('hidden'); clearSavedGame(); showMainMenu(); }));

            window.addEventListener('resize', debounce(adjustBoardSize, 100));
            document.body.addEventListener('click', async () => { if (!audioManager.isReady) { await Tone.start(); audioManager.init(); audioManager.toggleMute(isMuted); }}, { once: true });
            
            vkBridge.subscribe(e => {
                if (e.detail.type === 'VKWebAppViewHide') { if (!bgMusic.paused) { wasMusicPlaying = true; bgMusic.pause(); }}
                if (e.detail.type === 'VKWebAppViewRestore') { if (wasMusicPlaying && !isMuted) { bgMusic.play().catch(e => {}); } wasMusicPlaying = false; }
            });
        }
       
        function createFullGrid() {
            const grid = Array.from({ length: 9 }, () => Array(9).fill(null));
            solveSudoku(grid);
            return grid;
        }
        function solveSudoku(grid) {
            const emptySpot = findEmptySpot(grid);
            if (!emptySpot) return true;
            const [row, col] = emptySpot;
            const nums = [1, 2, 3, 4, 5, 6, 7, 8, 9].sort(() => Math.random() - 0.5);
            for (let num of nums) {
                if (isValid(grid, row, col, num)) {
                    grid[row][col] = num;
                    if (solveSudoku(grid)) return true;
                    grid[row][col] = null;
                }
            }
            return false;
        }
        function findEmptySpot(grid) {
            for (let r = 0; r < 9; r++) for (let c = 0; c < 9; c++) if (grid[r][c] === null) return [r, c];
            return null;
        }
        function isValid(grid, row, col, num) {
            for (let i = 0; i < 9; i++) if (grid[row][i] === num || grid[i][col] === num) return false;
            const startRow = row - row % 3, startCol = col - col % 3;
            for (let i = 0; i < 3; i++) for (let j = 0; j < 3; j++) if (grid[i + startRow][j + startCol] === num) return false;
            return true;
        }
        function removeCells(grid, count) {
            let removed = 0;
            while (removed < count) {
                const row = Math.floor(Math.random() * 9);
                const col = Math.floor(Math.random() * 9);
                if (grid[row][col] !== null) {
                    grid[row][col] = null;
                    removed++;
                }
            }
        }

        init();
    });
    </script>
</body>
</html>

