<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <title>Судоку Мастерс</title>
    <!-- VK Bridge -->
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <!-- Tone.js for Audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-family: 'Poppins', sans-serif;
            
            /* Light Theme */
            --bg-light: #F8FAFC;
            --surface-light: #FFFFFF;
            --primary-light: #14B8A6; 
            --primary-light-transparent: #14b8a633;
            --text-primary-light: #0F172A;
            --text-secondary-light: #64748B;
            --border-light: #E2E8F0;
            --error-light: #F43F5E;
            --highlight-area-light: #dbeafe; /* New distinct highlight color */

            /* Dark Theme (Re-themed for better aesthetics) */
            --bg-dark: #111827;
            --surface-dark: #1F2937;
            --primary-dark: #5EEAD4;
            --primary-dark-transparent: #5eead433;
            --text-primary-dark: #E5E7EB;
            --text-secondary-dark: #9CA3AF;
            --border-dark: #374151;
            --error-dark: #FCA5A5;
            --highlight-area-dark: #374151; /* Distinct highlight color */
        }

        [data-theme="dark"] {
            --bg-light: var(--bg-dark);
            --surface-light: var(--surface-dark);
            --primary-light: var(--primary-dark);
            --primary-light-transparent: var(--primary-dark-transparent);
            --text-primary-light: var(--text-primary-dark);
            --text-secondary-light: var(--text-secondary-dark);
            --border-light: var(--border-dark);
            --error-light: var(--error-dark);
            --highlight-area-light: var(--highlight-area-dark);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overscroll-behavior-y: contain; }
        body { font-family: var(--font-family); background-color: var(--bg-light); color: var(--text-primary-light); display: flex; justify-content: center; align-items: center; transition: background-color 0.3s, color 0.3s; overflow: hidden; }
       
        #app { width: 100%; height: 100%; max-width: 500px; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; padding: 15px; padding-top: env(safe-area-inset-top, 15px); padding-bottom: env(safe-area-inset-bottom, 15px); user-select: none; -webkit-user-select: none; }
        .hidden { display: none !important; }

        /* Main Menu */
        #main-menu { display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; height: 100%; gap: 30px; }
        .title-container { text-align: center; }
        .title-container .logo-text { font-size: clamp(2.5rem, 10vw, 3.5rem); font-weight: 700; color: var(--text-primary-light); letter-spacing: -2px; }
        .title-container .logo-text span { color: var(--primary-light); }
        .title-container .logo-subtext { font-size: 1rem; color: var(--text-secondary-light); margin-top: -5px; }

        .difficulty-buttons { display: flex; flex-direction: column; gap: 15px; width: 100%; max-width: 320px; }
        .menu-button {
            background-color: var(--surface-light);
            color: var(--text-primary-light);
            font-size: 1.1rem;
            font-weight: 600;
            border: 1px solid var(--border-light);
            padding: 18px 20px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03);
        }
        .menu-button:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.07), 0 4px 6px -2px rgba(0,0,0,0.05); }
        .menu-button.primary { background-color: var(--primary-light); color: #fff; border-color: var(--primary-light); }
        
        #menu-footer { display: flex; gap: 15px; position: absolute; bottom: env(safe-area-inset-bottom, 20px); }
        .footer-button { background-color: var(--surface-light); border: 1px solid var(--border-light); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; color: var(--text-secondary-light); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); cursor: pointer; }
        .footer-button svg { width: 24px; height: 24px; }

        /* Game Screen Layout */
        #game-screen { 
            width: 100%; 
            height: 100%; 
            display: grid;
            grid-template-rows: auto 1fr auto; /* Header, Board, Controls */
            gap: 10px;
        }
        header { display: flex; justify-content: space-between; align-items: center; width: 100%; flex-shrink: 0; }
        .header-block { display: flex; align-items: center; gap: 5px; }
        .icon-button { background: none; border: none; cursor: pointer; width: 44px; height: 44px; display: flex; justify-content: center; align-items: center; color: var(--text-secondary-light); }
        .icon-button svg { width: 26px; height: 26px; }
        #difficulty-display { background-color: var(--surface-light); border: 1px solid var(--border-light); padding: 4px 12px; border-radius: 20px; font-weight: 600; font-size: 0.9rem; }
        #timer { font-weight: 600; font-size: 1.1rem; color: var(--text-secondary-light); min-width: 50px; text-align: right; }
        #lives { display: flex; gap: 4px; color: var(--error-light); }
       
        #board-wrapper {
            display: flex; justify-content: center; align-items: center;
            width: 100%; min-height: 0;
        }
        #sudoku-board {
            border-collapse: collapse;
            border: 3px solid var(--text-primary-light);
            aspect-ratio: 1 / 1;
            margin: auto;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
        }
        #sudoku-board td {
            border: 1px solid var(--border-light); text-align: center; font-weight: 500;
            cursor: pointer; transition: background-color 0.2s;
            width: 11.111%; height: 11.111%; position: relative;
        }
        #sudoku-board td:nth-child(3n) { border-right: 2px solid var(--text-secondary-light); }
        #sudoku-board tr:nth-child(3n) { border-bottom: 2px solid var(--text-secondary-light); }
        #sudoku-board td:last-child { border-right: none; }
        #sudoku-board tr:last-child td { border-bottom: none; }

        .initial-number { color: var(--text-primary-light); font-weight: 700; }
        .player-number { color: var(--primary-light); font-weight: 600; }
        .incorrect { color: var(--error-light) !important; animation: shake 0.3s; }
        .highlight-area { background-color: var(--highlight-area-light) !important; }
        .highlight-number { background-color: var(--primary-light-transparent) !important; font-weight: 700; }
        .selected::after {
            content: ''; position: absolute; top: 2px; left: 2px; right: 2px; bottom: 2px;
            border: 3px solid var(--primary-light); border-radius: 8px;
        }

        /* Controls */
        #controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            width: 100%;
            flex-shrink: 0;
        }
        #number-pad { 
            display: grid; 
            grid-template-columns: repeat(9, 1fr); 
            gap: min(1.5vw, 6px); /* Reduced gap */
            width: 100%;
        }
        .control-button {
            background-color: var(--surface-light); color: var(--text-primary-light);
            font-size: clamp(1.2rem, 4.5vw, 1.8rem); /* Adjusted font size */
            font-weight: 600;
            border: 1px solid var(--border-light);
            cursor: pointer; transition: all 0.2s ease;
            display: flex; justify-content: center; align-items: center;
            position: relative;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            border-radius: 12px; /* Changed to rounded squares */
            aspect-ratio: 1/1;
        }
        .control-button.action {
            flex-shrink: 0; /* Prevent shrinking */
            width: clamp(55px, 15vw, 65px); /* Larger action buttons */
            height: clamp(55px, 15vw, 65px);
            border-radius: 16px;
        }
        .control-button.action svg { width: 50%; height: 50%; }
        .control-button:active { transform: scale(0.95); background-color: var(--highlight-area-light); }
        .ad-badge {
            position: absolute; top: 5px; right: 5px;
            background-color: var(--primary-light); color: white;
            padding: 1px 5px; border-radius: 6px; font-size: 9px;
            font-weight: 600; line-height: 1; border: 1px solid var(--surface-light);
        }

        /* Modals */
        .modal-overlay { position: fixed; inset:0; backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 20px; animation: fadeIn 0.3s ease; }
        .modal-content { 
            background-color: var(--surface-light); padding: 30px; border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid var(--border-light);
            width: 100%; max-width: 400px; text-align: center;
        }
        .modal-content h2 { font-size: 1.8rem; font-weight: 700; margin-bottom: 10px; }
        .modal-content h3 { font-size: 1.5rem; margin-bottom: 20px; }
        .modal-content p { margin-bottom: 25px; font-size: 1rem; color: var(--text-secondary-light); }
        .modal-buttons { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }

        /* Settings Modal */
        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--border-light); }
        .setting-row:last-child { border-bottom: none; }
        .setting-row label { font-size: 1.1rem; font-weight: 600; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: var(--border-light); transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-light); }
        input:checked + .slider:before { transform: translateX(22px); }

        /* Stats Table */
        .stats-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .stats-table th, .stats-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-light); }
        .stats-table th { font-size: 0.9rem; font-weight: 600; color: var(--text-secondary-light); text-transform: uppercase; }
        .stats-table td { font-weight: 500; }
        .stats-table td:last-child { text-align: right; font-weight: 600; }
        .stats-table tbody tr:last-child td { border-bottom: none; }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-3px); } 75% { transform: translateX(3px); } }
    </style>
</head>
<body>
    <audio id="bg-music" loop src="music.mp3"></audio>
    <div id="app">
        <div id="main-menu" class="active">
            <div class="title-container">
                <h1 class="logo-text">Судоку <span>Мастерс</span></h1>
                <p class="logo-subtext">Тренируй свой мозг</p>
            </div>
            <div class="difficulty-buttons">
                <button class="menu-button" data-difficulty="easy">Новичок</button>
                <button class="menu-button" data-difficulty="medium">Любитель</button>
                <button class="menu-button" data-difficulty="hard">Профи</button>
                <button class="menu-button" data-difficulty="expert">Мастер</button>
            </div>
            <div id="menu-footer">
                <button id="main-menu-stats-btn" class="footer-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20V10"></path><path d="M18 20V4"></path><path d="M6 20V16"></path></svg>
                </button>
                <button id="main-menu-settings-btn" class="footer-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>
            </div>
        </div>

        <div id="game-screen" class="hidden">
            <header>
                <div class="header-block">
                    <button id="pause-btn" class="icon-button">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="8" y2="18"></line><line x1="16" y1="6" x2="16" y2="18"></line></svg>
                    </button>
                </div>
                <div class="header-block">
                    <div id="difficulty-display"></div>
                </div>
                <div class="header-block" style="justify-content: flex-end;">
                     <div id="lives"></div>
                     <div id="timer">00:00</div>
                </div>
             </header>
            <div id="board-wrapper">
                <table id="sudoku-board"></table>
            </div>
            <div id="controls">
                <!-- Controls are now generated dynamically -->
            </div>
        </div>

        <div id="modal-container" class="hidden"></div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        vkBridge.send('VKWebAppInit');
        document.addEventListener('contextmenu', e => e.preventDefault());
       
        // --- DOM Elements ---
        const mainMenu = document.getElementById('main-menu');
        const gameScreen = document.getElementById('game-screen');
        const sudokuBoard = document.getElementById('sudoku-board');
        const controlsContainer = document.getElementById('controls');
        const difficultyDisplay = document.getElementById('difficulty-display');
        const timerDisplay = document.getElementById('timer');
        const livesDisplay = document.getElementById('lives');
        const pauseBtn = document.getElementById('pause-btn');
        const difficultyButtonsContainer = document.querySelector('.difficulty-buttons');
        const mainMenuSettingsBtn = document.getElementById('main-menu-settings-btn');
        const mainMenuStatsBtn = document.getElementById('main-menu-stats-btn');
        const modalContainer = document.getElementById('modal-container');
        const bgMusic = document.getElementById('bg-music');
        
        // --- Game State ---
        let vkUserId = null;
        let wasMusicPlaying = false;
        let timerInterval;
        let startTime;
        let elapsedTime = 0;
        const difficultyLevels = { easy: 30, medium: 40, hard: 50, expert: 60 };
        const difficultyMap = { easy: 'Новичок', medium: 'Любитель', hard: 'Профи', expert: 'Мастер' };
        let currentLevel = '';
        let selectedCell = null;
        let solutionGrid = [], initialGrid = [], playerGrid = [];
        let lives = 3;
        let isPaused = false;
        let stats = {};
        let isSfxMuted = false;
        let isMusicMuted = false;
        let currentTheme = 'light';
        let savedGameState = null;

        // --- Audio Manager ---
        const audioManager = {
            isReady: false,
            init() {
                this.clickSynth = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.1 } }).toDestination();
                this.clickSynth.volume.value = -20;
                this.winSynth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'triangle8' }, envelope: { attack: 0.02, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination();
                this.winSynth.volume.value = -10;
                this.errorSynth = new Tone.MonoSynth({ oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.2 } }).toDestination();
                this.errorSynth.volume.value = -15;
                bgMusic.volume = 0.05;
                this.isReady = true;
            },
            playSound(sound) {
                if (!this.isReady || isSfxMuted) return;
                try {
                    const now = Tone.now();
                    if (sound === 'click') this.clickSynth.triggerAttackRelease('E5', '8n', now);
                    if (sound === 'win') ["C5", "E5", "G5", "C6"].forEach((n, i) => this.winSynth.triggerAttackRelease(n, "16n", now + i * 0.1));
                    if (sound === 'error') this.errorSynth.triggerAttackRelease('F#3', '8n', now);
                } catch(e) { console.error("Sound play error", e); }
            },
            toggleSfxMute(forceState) {
                isSfxMuted = (typeof forceState === 'boolean') ? forceState : !isSfxMuted;
                if (document.getElementById('sound-toggle')) document.getElementById('sound-toggle').checked = !isSfxMuted;
                Tone.Master.mute = isSfxMuted;
                if(typeof forceState === 'undefined') saveData();
            },
            toggleMusicMute(forceState) {
                isMusicMuted = (typeof forceState === 'boolean') ? forceState : !isMusicMuted;
                if (document.getElementById('music-toggle')) document.getElementById('music-toggle').checked = !isMusicMuted;
                if (isMusicMuted) {
                    bgMusic.pause();
                } else {
                    bgMusic.play().catch(e => {});
                }
                if(typeof forceState === 'undefined') saveData();
            }
        };

        // --- Modals ---
        function showModal(id, content) { const modal = document.createElement('div'); modal.id = id; modal.className = 'modal-overlay'; modal.innerHTML = `<div class="modal-content">${content}</div>`; modalContainer.appendChild(modal); modalContainer.classList.remove('hidden'); modal.addEventListener('click', (e) => { if (e.target.closest('.modal-content')) return; if(id !== 'continue-modal') hideModal(id); }); }
        function hideModal(id) { const modal = document.getElementById(id); if (modal) { modal.remove(); } if (modalContainer.children.length === 0) { modalContainer.classList.add('hidden'); } }

        // --- Data Management ---
        async function saveData() {
            if (!vkUserId) return;
            const hasProgress = playerGrid.length > 0 && playerGrid.flat().some(cell => cell !== null);
            const gameStateToSave = hasProgress ? { playerGrid, initialGrid, solutionGrid, currentLevel, lives, elapsedTime } : null;
            const dataToSave = JSON.stringify({ stats, isSfxMuted, isMusicMuted, currentTheme, savedGame: gameStateToSave });
            try {
                await vkBridge.send('VKWebAppStorageSet', { key: `sudoku_masters_data_v5_${vkUserId}`, value: dataToSave });
            } catch (e) { localStorage.setItem(`sudoku_masters_data_v5_${vkUserId}`, dataToSave); }
        }
        async function loadData() {
            if (!vkUserId) return;
            let loadedData = null;
            const key = `sudoku_masters_data_v5_${vkUserId}`;
            try {
                const response = await vkBridge.send('VKWebAppStorageGet', { keys: [key] });
                if (response.keys[0]?.value) loadedData = JSON.parse(response.keys[0].value);
            } catch (e) {
                const localData = localStorage.getItem(key);
                if (localData) loadedData = JSON.parse(localData);
            }
            if (loadedData) {
                stats = loadedData.stats || {};
                isSfxMuted = loadedData.isSfxMuted || false;
                isMusicMuted = loadedData.isMusicMuted || false;
                currentTheme = loadedData.currentTheme || 'light';
                savedGameState = loadedData.savedGame || null;
            }
        }
        function clearSavedGame() { savedGameState = null; saveData(); }
       
        // --- Screen Management ---
        function showMainMenu() {
            mainMenu.classList.remove('hidden');
            mainMenu.classList.add('active');
            gameScreen.classList.add('hidden');
            gameScreen.classList.remove('active');
            if (!isMusicMuted) bgMusic.play().catch(e => {});
            vkBridge.send('VKWebAppShowBannerAd', { banner_location: 'bottom' }).catch(e => {});
        }
        function startGame(level) {
            currentLevel = level;
            difficultyDisplay.textContent = difficultyMap[level];
            mainMenu.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            mainMenu.classList.remove('active');
            gameScreen.classList.add('active');
            resetGame();
            vkBridge.send('VKWebAppShowBannerAd', { banner_location: 'bottom' }).catch(e => {});
            setTimeout(adjustBoardSize, 0);
        }
        function continueGame() {
            if (!savedGameState) return;
            ({ playerGrid, initialGrid, solutionGrid, currentLevel, lives, elapsedTime } = savedGameState);
            difficultyDisplay.textContent = difficultyMap[currentLevel];
            mainMenu.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            mainMenu.classList.remove('active');
            gameScreen.classList.add('active');
            isPaused = false;
            selectedCell = null;
            clearInterval(timerInterval);
            updateLivesDisplay();
            drawBoard();
            startTimer();
            if (!isMusicMuted) bgMusic.play().catch(e => {});
            vkBridge.send('VKWebAppShowBannerAd', { banner_location: 'bottom' }).catch(e => {});
            setTimeout(adjustBoardSize, 0);
        }
       
        // --- Game Logic ---
        function resetGame() { lives = 3; elapsedTime = 0; isPaused = false; selectedCell = null; clearInterval(timerInterval); updateLivesDisplay(); generateSudoku(); drawBoard(); startTimer(); }
        function updateThemeUI(theme) { currentTheme = theme; document.body.dataset.theme = theme; const themeToggle = document.getElementById('theme-toggle'); if (themeToggle) themeToggle.checked = theme === 'dark'; saveData(); }
        function generateSudoku() { solutionGrid = createFullGrid(); initialGrid = JSON.parse(JSON.stringify(solutionGrid)); removeCells(initialGrid, difficultyLevels[currentLevel]); playerGrid = JSON.parse(JSON.stringify(initialGrid)); }
        function drawBoard() { sudokuBoard.innerHTML = ''; for (let r = 0; r < 9; r++) { const row = sudokuBoard.insertRow(); for (let c = 0; c < 9; c++) { const cell = row.insertCell(); cell.dataset.row = r; cell.dataset.col = c; const initialValue = initialGrid[r][c]; const playerValue = playerGrid[r][c]; if (initialValue !== null) { cell.textContent = initialValue; cell.classList.add('initial-number'); } else if (playerValue !== null) { cell.textContent = playerValue; cell.classList.add('player-number'); } } } }
        function adjustBoardSize() { const container = document.getElementById('board-wrapper'); if (!container || !sudokuBoard) return; const size = Math.min(container.clientWidth, container.clientHeight); sudokuBoard.style.width = `${size}px`; sudokuBoard.style.height = `${size}px`; sudokuBoard.style.fontSize = `${size / 20}px`; }
        function handleCellClick(e) { const cell = e.target.closest('td'); if (!cell || isPaused) return; audioManager.playSound('click'); if (selectedCell === cell) { cell.classList.remove('selected'); selectedCell = null; clearHighlights(); return; } if (selectedCell) selectedCell.classList.remove('selected'); clearHighlights(); selectedCell = cell; cell.classList.add('selected'); const row = cell.dataset.row, col = cell.dataset.col; highlightArea(row, col); if (cell.textContent) highlightNumber(cell.textContent); }
        function handleNumberInput(num) { if (!selectedCell || selectedCell.classList.contains('initial-number') || isPaused) return; audioManager.playSound('click'); const r = parseInt(selectedCell.dataset.row), c = parseInt(selectedCell.dataset.col); if (num === null) { playerGrid[r][c] = null; selectedCell.textContent = ''; selectedCell.classList.remove('incorrect', 'player-number'); } else { playerGrid[r][c] = num; selectedCell.textContent = num; selectedCell.classList.add('player-number'); } saveData(); if (num !== null && num !== solutionGrid[r][c]) { selectedCell.classList.add('incorrect'); loseLife(); } else { if(num !== null) selectedCell.classList.remove('incorrect'); clearHighlights(); highlightArea(r,c); if (num) highlightNumber(num); selectedCell.classList.add('selected'); checkWin(); } }
        async function handleHint() { audioManager.playSound('click'); if(isPaused) return; try { await vkBridge.send('VKWebAppCheckNativeAds', { ad_format: 'reward' }); const adData = await vkBridge.send('VKWebAppShowNativeAds', { ad_format: 'reward' }); if (adData.result) { const emptyCells = []; for(let r=0; r<9; r++) for(let c=0; c<9; c++) if(playerGrid[r][c] === null) emptyCells.push({r, c}); if (emptyCells.length > 0) { const randomCell = emptyCells[Math.floor(Math.random() * emptyCells.length)]; handleCellClick({ target: sudokuBoard.rows[randomCell.r].cells[randomCell.c] }); handleNumberInput(solutionGrid[randomCell.r][randomCell.c]); } } } catch (e) { console.error("Rewarded ad error:", e); } }
        function loseLife() { audioManager.playSound('error'); lives--; updateLivesDisplay(); if (lives <= 0) { clearInterval(timerInterval); showGameOverModal(); clearSavedGame(); } }
        async function getExtraLife() { audioManager.playSound('click'); try { await vkBridge.send('VKWebAppCheckNativeAds', { ad_format: 'reward' }); const adData = await vkBridge.send('VKWebAppShowNativeAds', { ad_format: 'reward' }); if (adData.result) { lives++; updateLivesDisplay(); hideModal('game-over-modal'); startTimer(); } } catch (e) { console.error("Rewarded ad error:", e); } }
        function updateLivesDisplay() { livesDisplay.innerHTML = ''; for (let i = 0; i < 3; i++) { const heart = document.createElement('span'); heart.innerHTML = i < lives ? `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>` : `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity:0.3"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`; livesDisplay.appendChild(heart); } }
        function clearHighlights() { document.querySelectorAll('#sudoku-board td').forEach(c => c.classList.remove('highlight-area', 'highlight-number')); }
        function highlightArea(row, col) { for (let i = 0; i < 9; i++) { sudokuBoard.rows[row].cells[i].classList.add('highlight-area'); sudokuBoard.rows[i].cells[col].classList.add('highlight-area'); } }
        function highlightNumber(num) { document.querySelectorAll('#sudoku-board td').forEach(cell => { if (cell.textContent == num) cell.classList.add('highlight-number') }); }
        function checkWin() { for (let r = 0; r < 9; r++) for (let c = 0; c < 9; c++) if (playerGrid[r][c] !== solutionGrid[r][c]) return false; clearInterval(timerInterval); audioManager.playSound('win'); showWinModal(); updateStatsOnWin(); clearSavedGame(); vkBridge.send('VKWebAppShowInterstitialAd').catch(e => {}); return true; }
        function startTimer() { clearInterval(timerInterval); startTime = Date.now() - elapsedTime * 1000; timerInterval = setInterval(() => { elapsedTime = Math.floor((Date.now() - startTime) / 1000); const minutes = String(Math.floor(elapsedTime / 60)).padStart(2, '0'), seconds = String(elapsedTime % 60).padStart(2, '0'); timerDisplay.textContent = `${minutes}:${seconds}`; }, 1000); }
        function togglePause() { audioManager.playSound('click'); isPaused = !isPaused; if (isPaused) { clearInterval(timerInterval); showPauseModal(); } else { startTimer(); hideModal('pause-modal'); } }
        function updateStatsOnWin() { if (!stats[currentLevel]) stats[currentLevel] = { wins: 0, bestTime: null }; const levelStats = stats[currentLevel]; levelStats.wins++; if (levelStats.bestTime === null || elapsedTime < levelStats.bestTime) { levelStats.bestTime = elapsedTime; } saveData(); }
        
        // --- Sudoku Generation ---
        function createFullGrid() { const grid = Array.from({ length: 9 }, () => Array(9).fill(null)); solveSudoku(grid); return grid; }
        function solveSudoku(grid) { const emptySpot = findEmptySpot(grid); if (!emptySpot) return true; const [row, col] = emptySpot; const nums = [1, 2, 3, 4, 5, 6, 7, 8, 9].sort(() => Math.random() - 0.5); for (let num of nums) { if (isValid(grid, row, col, num)) { grid[row][col] = num; if (solveSudoku(grid)) return true; grid[row][col] = null; } } return false; }
        function findEmptySpot(grid) { for (let r = 0; r < 9; r++) for (let c = 0; c < 9; c++) if (grid[r][c] === null) return [r, c]; return null; }
        function isValid(grid, row, col, num) { for (let i = 0; i < 9; i++) if (grid[row][i] === num || grid[i][col] === num) return false; const startRow = row - row % 3, startCol = col - col % 3; for (let i = 0; i < 3; i++) for (let j = 0; j < 3; j++) if (grid[i + startRow][j + startCol] === num) return false; return true; }
        function removeCells(grid, count) { let removed = 0; while (removed < count) { const row = Math.floor(Math.random() * 9), col = Math.floor(Math.random() * 9); if (grid[row][col] !== null) { grid[row][col] = null; removed++; } } }

        // --- Event Listeners and Init ---
        function setupControls() {
            controlsContainer.innerHTML = ''; // Clear previous controls
            
            const hintBtn = document.createElement('button');
            hintBtn.className = 'control-button action';
            hintBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7zM9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1z"></path></svg><span class="ad-badge">Ad</span>`;
            hintBtn.onclick = handleHint;

            const numberPad = document.createElement('div');
            numberPad.id = 'number-pad';
            for (let i = 1; i <= 9; i++) {
                const btn = document.createElement('button');
                btn.className = 'control-button';
                btn.textContent = i;
                btn.onclick = () => handleNumberInput(i);
                numberPad.appendChild(btn);
            }
            
            const eraseBtn = document.createElement('button');
            eraseBtn.className = 'control-button action';
            eraseBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path><line x1="18" y1="9" x2="12" y2="15"></line><line x1="12" y1="9" x2="18" y2="15"></line></svg>`;
            eraseBtn.onclick = () => handleNumberInput(null);
            
            controlsContainer.appendChild(hintBtn);
            controlsContainer.appendChild(numberPad);
            controlsContainer.appendChild(eraseBtn);
        }

        function addEventListeners() {
            const click = (el, fn) => { if(el) el.addEventListener('click', () => { fn(); }); };
            
            difficultyButtonsContainer.addEventListener('click', (e) => {
                const button = e.target.closest('.menu-button');
                if (button && button.dataset.difficulty) {
                    audioManager.playSound('click');
                    startGame(button.dataset.difficulty);
                }
            });

            click(mainMenuStatsBtn, () => { audioManager.playSound('click'); showStatsModal(); });
            click(mainMenuSettingsBtn, () => { audioManager.playSound('click'); showSettingsModal(); });
            click(pauseBtn, togglePause);
            sudokuBoard.addEventListener('click', handleCellClick);
            
            window.addEventListener('resize', debounce(adjustBoardSize, 100));
            document.body.addEventListener('click', async () => { if (!audioManager.isReady) { await Tone.start(); audioManager.init(); audioManager.toggleSfxMute(isSfxMuted); if(!isMusicMuted) audioManager.toggleMusicMute(isMusicMuted); }}, { once: true });
            
            vkBridge.subscribe(e => {
                if (e.detail.type === 'VKWebAppViewHide') {
                    if (!bgMusic.paused) { wasMusicPlaying = true; bgMusic.pause(); }
                    Tone.Master.mute = true;
                }
                if (e.detail.type === 'VKWebAppViewRestore') {
                    if (wasMusicPlaying && !isMusicMuted) bgMusic.play().catch(e => {});
                    wasMusicPlaying = false;
                    Tone.Master.mute = isSfxMuted;
                }
            });
        }
        
        const debounce = (func, wait) => { let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; };

        // --- Modal Content and Handlers ---
        const showContinueModal = () => { showModal('continue-modal', `<h2>Сохраненная игра</h2><p>У вас есть незаконченная игра. Хотите продолжить?</p><div class="modal-buttons"><button id="continue-game-btn" class="menu-button primary">Продолжить</button><button id="new-game-continue-btn" class="menu-button">Начать заново</button></div>`); };
        const showPauseModal = () => { showModal('pause-modal', `<h2>Пауза</h2><div class="modal-buttons"><button id="resume-button" class="menu-button primary">Продолжить</button><button id="restart-button" class="menu-button">Начать заново</button><button id="settings-btn-pause" class="menu-button">Настройки</button><button id="main-menu-btn-pause" class="menu-button">Главное меню</button></div>`); };
        const showGameOverModal = () => { showModal('game-over-modal', `<h2>Вы проиграли</h2><div class="modal-buttons"><button id="extra-life-btn" class="menu-button primary">Доп. жизнь (Ad)</button><button id="restart-game-over-btn" class="menu-button">Начать заново</button><button id="main-menu-game-over-btn" class="menu-button">Главное меню</button></div>`); };
        const showWinModal = () => { showModal('win-modal', `<h2>Поздравляем!</h2><p id="completion-time">Время: ${timerDisplay.textContent}</p><div class="modal-buttons"><button id="new-game-win-btn" class="menu-button primary">Новая игра</button><button id="main-menu-win-btn" class="menu-button">Главное меню</button></div>`); };
        const showSettingsModal = () => { showModal('settings-modal', `<h2>Настройки</h2><div class="settings-content"><div class="setting-row"><label for="music-toggle">Музыка</label><label class="switch"><input type="checkbox" id="music-toggle"><span class="slider"></span></label></div><div class="setting-row"><label for="sound-toggle">Звуки (SFX)</label><label class="switch"><input type="checkbox" id="sound-toggle"><span class="slider"></span></label></div><div class="setting-row"><label for="theme-toggle">Темная тема</label><label class="switch"><input type="checkbox" id="theme-toggle"><span class="slider"></span></label></div></div><div class="modal-buttons"><button id="close-settings-btn" class="menu-button primary">Закрыть</button></div>`); document.getElementById('music-toggle').checked = !isMusicMuted; document.getElementById('sound-toggle').checked = !isSfxMuted; document.getElementById('theme-toggle').checked = currentTheme === 'dark'; document.getElementById('music-toggle').onchange = (e) => audioManager.toggleMusicMute(!e.target.checked); document.getElementById('sound-toggle').onchange = (e) => audioManager.toggleSfxMute(!e.target.checked); document.getElementById('theme-toggle').onchange = (e) => updateThemeUI(e.target.checked ? 'dark' : 'light'); };
        const showStatsModal = () => { showModal('stats-modal', `<h3>Статистика</h3><div id="stats-table-container"></div><div class="modal-buttons"><button id="close-stats-btn" class="menu-button primary">Закрыть</button></div>`); const container = document.getElementById('stats-table-container'); const table = document.createElement('table'); table.className = 'stats-table'; table.innerHTML = `<thead><tr><th>Сложность</th><th>Побед</th><th>Лучшее время</th></tr></thead><tbody></tbody>`; const tbody = table.querySelector('tbody'); Object.keys(difficultyLevels).forEach(levelKey => { const levelName = difficultyMap[levelKey]; const levelStats = stats[levelKey] || { wins: 0, bestTime: null }; const formatTime = s => s === null ? '—' : `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`; const tr = document.createElement('tr'); tr.innerHTML = `<td>${levelName}</td><td>${levelStats.wins || '—'}</td><td>${formatTime(levelStats.bestTime)}</td>`; tbody.appendChild(tr); }); container.appendChild(table); };

        modalContainer.addEventListener('click', e => {
            const target = e.target.closest('button');
            if (!target) return;
            const id = target.id;
            const modalId = target.closest('.modal-overlay')?.id;
            const action = (fn) => { audioManager.playSound('click'); if(fn) fn(); };
            
            switch(id) {
                case 'continue-game-btn': action(() => { hideModal(modalId); continueGame(); }); break;
                case 'new-game-continue-btn': action(() => { hideModal(modalId); clearSavedGame(); showMainMenu(); }); break;
                case 'resume-button': action(togglePause); break;
                case 'restart-button': action(() => { hideModal(modalId); resetGame(); setTimeout(adjustBoardSize, 0); }); break;
                case 'settings-btn-pause': action(showSettingsModal); break;
                case 'main-menu-btn-pause': action(() => { hideModal(modalId); clearSavedGame(); showMainMenu(); }); break;
                case 'extra-life-btn': getExtraLife(); break;
                case 'restart-game-over-btn': action(() => { hideModal(modalId); resetGame(); setTimeout(adjustBoardSize, 0); }); break;
                case 'main-menu-game-over-btn': action(() => { hideModal(modalId); clearSavedGame(); showMainMenu(); }); break;
                case 'new-game-win-btn': action(() => { hideModal(modalId); startGame(Object.keys(difficultyLevels)[Math.floor(Math.random() * 4)]); }); break;
                case 'main-menu-win-btn': action(() => { hideModal(modalId); showMainMenu(); }); break;
                case 'close-stats-btn': action(() => hideModal(modalId)); break;
                case 'close-settings-btn': action(() => hideModal(modalId)); break;
            }
        });

        async function init() {
            try {
                const user = await vkBridge.send('VKWebAppGetUserInfo');
                vkUserId = user.id;
            } catch (error) { vkUserId = 'test_user'; }
            
            await loadData();
            updateThemeUI(currentTheme);
            setupControls();
            addEventListeners();
            
            if (savedGameState) {
                showContinueModal();
            } else {
                showMainMenu();
            }
        }

        init();
    });
    </script>
</body>
</html>


